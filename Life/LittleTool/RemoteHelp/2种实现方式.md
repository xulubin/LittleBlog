# 只是做一个简单的记录
> 目前只是自己尝试后，认为可行的方案，做一个记录。
> 明确一下我的诉求：更多的是需要看到对方的屏幕，从而进行指导操作。尽可能地减少对方的操作难度。
> 不适用时，将相关app冻结即可，保障使用安全

## 方式一：利用Anydesk
* windows端可以使用单文件（不安装）
* Android端安装使用apk即可

可圈可点的是：应用程序可以设置白名单，有效保证了使用的安全。

美中不足的是，Android端（被协助方），除了需要点击运行软件外，还需要进行屏幕上的点击确认（选择“整个屏幕”共享）

待补充：
使用macro进行自动化点击，简化被协助方的操作难度。


## 方式二：使用tailscale

* windows端和Android端安装tailscale客户端，登陆同一个账号
* windows可以进入控制台（web网页端）得到当前Android设备的地址
* 使用脚本，完成“当Android启动tailscale进程，自动打开端口6666的无线调试；当Android结束tailscale进程，自动关闭无线调试”，从而实现“按需连接”

目前使用的脚本是`tailscale_process_monitor.sh`
```sh
#!/system/bin/sh

# Tailscale进程监控脚本
ADB_PORT=6666
CHECK_INTERVAL=5
LOG_FILE="/data/local/tmp/tailscale_process.log"
TAILSCALE_PACKAGE="com.tailscale.ipn"

# 日志函数
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> $LOG_FILE
}

# 检查进程状态
check_process() {
    # 方法1: 通过ps检查
    ps -A | grep "$TAILSCALE_PACKAGE" | grep -v grep > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        return 0
    fi
    
    # 方法2: 通过am检查
    dumpsys activity services "$TAILSCALE_PACKAGE" | grep "ServiceRecord" > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        return 0
    fi
    
    return 1
}

# 检查VPN服务状态
check_vpn_service() {
    dumpsys connectivity | grep "tailscale" > /dev/null 2>&1
    return $?
}

# ADB控制函数
control_adb() {
    local action=$1
    
    if [ "$action" = "enable" ]; then
        local current_port=$(getprop service.adb.tcp.port)
        if [ "$current_port" = "$ADB_PORT" ]; then
            return 0
        fi
        
        log "开启ADB端口 $ADB_PORT"
        setprop service.adb.tcp.port $ADB_PORT
        stop adbd
        start adbd
        
    elif [ "$action" = "disable" ]; then
        local current_port=$(getprop service.adb.tcp.port)
        if [ "$current_port" = "-1" ] || [ -z "$current_port" ]; then
            return 0
        fi
        
        log "关闭ADB"
        setprop service.adb.tcp.port -1
        stop adbd
        start adbd
    fi
}

# 主监控循环
monitor_loop() {
    log "开始监控Tailscale进程"
    
    local was_running=false
    
    while true; do
        if check_process || check_vpn_service; then
            if [ "$was_running" = "false" ]; then
                log "Tailscale启动 detected"
                control_adb enable
                was_running=true
            fi
        else
            if [ "$was_running" = "true" ]; then
                log "Tailscale停止 detected"
                control_adb disable
                was_running=false
            fi
        fi
        
        sleep $CHECK_INTERVAL
    done
}

# 启动监控
monitor_loop &
```

将脚本保存至android设备`/data/adb/service.d/`路径下，
并给予权限,实现开机自启
```bash
# 设置执行权限
chmod 755 /data/adb/service.d/tailscale_process_monitor.sh

# 设置所有者
chown root:shell /data/adb/service.d/tailscale_process_monitor.sh
```

